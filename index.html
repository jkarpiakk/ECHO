<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formularz ECHO CLS</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2/dist/tailwind.min.css" rel="stylesheet">
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- docx.js UMD Bundle for DOCX -->
  <script src="https://cdn.jsdelivr.net/npm/docx@7.3.0/build/docx.umd.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6 bg-white shadow-md mt-10 rounded-lg">
    <header class="flex items-center mb-6">
      <img src="logo_szpitala.png" alt="Logo kliniki" class="h-16 mr-4">
      <div>
        <h1 class="text-xl font-bold">Klinika Kardiologii z Pododdziałem Ostrych Zespołów Wieńcowych</h1>
        <p>Kliniczny Szpital Wojewódzki Nr 2 im. Św. Jadwigi Królowej w Rzeszowie</p>
        <p>ul. Lwowska 60, 35‑301 Rzeszów</p>
      </div>
    </header>
    <h2 class="text-lg font-semibold mb-4">Formularz badania echokardiograficznego</h2>
    <form id="echoForm" class="space-y-6">
      <!-- 1. Dane pacjenta -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">1. Dane pacjenta</legend>
        <div class="grid grid-cols-2 gap-4 mt-2">
          <div><label class="block text-sm">Imię i nazwisko<input name="patientName" type="text" class="w-full border rounded p-2"/></label></div>
          <div><label class="block text-sm">Nr badania / ID pacjenta<input name="patientID" type="text" class="w-full border rounded p-2"/></label></div>
          <div><label class="block text-sm">Data badania<input name="examDate" type="date" class="w-full border rounded p-2"/></label></div>
          <div><label class="block text-sm">Operator / lekarz<input name="operator" type="text" class="w-full border rounded p-2"/></label></div>
        </div>
      </fieldset>

      <!-- 2. Wymiary jam serca -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">2. Wymiary jam serca (M-mode / 2D)</legend>
        <div class="grid grid-cols-3 gap-4 mt-2" id="dimContainer"></div>
      </fieldset>

      <!-- 3. Średnice pni naczyniowych -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">3. Średnice pni naczyniowych</legend>
        <div class="grid grid-cols-3 gap-4 mt-2" id="vesContainer"></div>
      </fieldset>

      <!-- 4. Objętości i funkcja skurczowa -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">4. Objętości i funkcja skurczowa</legend>
        <div class="space-y-2 mt-2">
          <div>
            <label class="block text-sm">Frakcja wyrzutowa (EF) [%]<input name="EF" type="number" step="any" class="w-24 border rounded p-2"/></label>
            <span class="ml-4 text-sm">Metoda:</span>
            <select name="EFmethod" class="border rounded p-1">
              <option value="">-</option>
              <option value="Simpson">Simpson</option>
              <option value="Teichholz">Teichholz</option>
              <option value="Inna">Inna</option>
            </select>
          </div>
          <div><label class="block text-sm">EDV [ml]<input name="EDV" type="number" step="any" class="w-24 border rounded p-2"/></label></div>
          <div><label class="block text-sm">ESV [ml]<input name="ESV" type="number" step="any" class="w-24 border rounded p-2"/></label></div>
        </div>
      </fieldset>

      <!-- 5. Odcinkowe zaburzenia kurczliwości -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">5. Odcinkowe zaburzenia kurczliwości</legend>
        <div class="mt-2">
          <label class="inline-flex items-center"><input type="checkbox" name="segmentalPresent" class="form-checkbox"/><span class="ml-2">Obecne</span></label>
          <label class="block text-sm mt-2">Opis segmentów/uwagi<textarea name="segmentalDescription" class="w-full border rounded p-2 mt-1"></textarea></label>
        </div>
      </fieldset>

      <!-- 6. TAPSE -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">6. TAPSE</legend>
        <label class="block text-sm mt-2">Wartość [mm]<input name="TAPSE" type="number" step="any" class="w-24 border rounded p-2"/></label>
      </fieldset>

      <!-- 7. Ocena zastawek -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">7. Ocena zastawek</legend>
        <div class="space-y-6 mt-2">
          <!-- 7.1 Mitralna -->
          <div>
            <h3 class="font-semibold">7.1 Zastawka mitralna</h3>
            <div class="grid grid-cols-3 gap-4 mt-2">
              <div><label class="block text-sm">Stopień regurgitacji<select name="mitralRegurg" class="w-full border rounded p-1"><option value="">-</option><option value="łagodna">łagodna</option><option value="umiarkowana">umiarkowana</option><option value="ciężka">ciężka</option></select></label></div>
              <div><label class="block text-sm">VC [cm²]<input name="mitralVC" type="number" step="any" class="w-full border rounded p-2"/></label></div>
              <div><label class="block text-sm">PISA [mm]<input name="mitralPISA" type="number" step="any" class="w-full border rounded p-2"/></label></div>
            </div>
            <div class="grid grid-cols-3 gap-4 mt-2">
              <div><label class="block text-sm">ERO [cm²]<input name="mitralERO" type="number" step="any" class="w-full border rounded p-2"/></label></div>
              <div><label class="block text-sm">E/A ratio<input name="mitralEAratio" type="text" class="w-full border rounded p-2"/></label></div>
              <div><label class="block text-sm">MxPG [mmHg]<input name="mitralMxPG" type="number" step="any" class="w-full border rounded p-2"/></label></div>
            </div>
            <div class="mt-2"><label class="block text-sm">MnPG [mmHg]<input name="mitralMnPG" type="number" step="any" class="w-full border rounded p-2"/></label></div>
          </div>
          <!-- 7.2 Aortalna -->
          <div>
            <h3 class="font-semibold">7.2 Zastawka aortalna</h3>
            <div class="grid grid-cols-2 gap-4 mt-2">
              <div><label class="block text-sm">Morfologia<select name="aorticMorphology" class="w-full border rounded p-1"><option value="">-</option><option value="trójpłatkowa">trójpłatkowa</option><option value="dwupłatkowa">dwupłatkowa</option></select></label></div>
              <div><label class="block text-sm">Stopień stenoz/regurg<select name="aorticRegSten" class="w-full border rounded p-1"><option value="">-</option><option value="łagodna">łagodna</option><option value="umiarkowana">umiarkowana</option><option value="ciężka">ciężka</option></select></label></div>
            </div>
            <div class="grid grid-cols-4 gap-4 mt-2">
              <div><label class="block text-sm">VC [cm²]<input name="aorticVC" type="number" step="any" class="w-full border rounded p-2"/></label></div>
              <div><label class="block text-sm">PHT [ms]<input name="aorticPHT" type="number" step="any" class="w-full border rounded p-2"/></label></div>
              <div><label class="block text-sm">Vmax [m/s]<input name="aorticVmax" type="number" step="any" class="w-full border rounded p-2"/></label></div>
              <div><label class="block text-sm">Pmax [mmHg]<input name="aorticPmax" type="number" step="any" class="w-full border rounded p-2"/></label></div>
            </div>
          </div>
          <!-- 7.3 Trójdzielna -->
          <div>
            <h3 class="font-semibold">7.3 Zastawka trójdzielna</h3>
            <div class="grid grid-cols-2 gap-4 mt-2">
              <div><label class="block text-sm">Stopień regurgitacji<select name="tricuspidRegurg" class="w-full border rounded p-1"><option value="">-</option><option value="łagodna">łagodna</option><option value="umiarkowana">umiarkowana</option><option value="ciężka">ciężka</option></select></label></div>
              <div><label class="block text-sm">TR Vmax [m/s]<input name="tricuspidVmax" type="number" step="any" class="w-full border rounded p-2"/></label></div>
            </div>
            <div class="mt-2"><label class="block text-sm">Pmax [mmHg]<input name="tricuspidPmax" type="number" step="any" class="w-full border rounded p-2"/></label></div>
          </div>
        </div>
      </fieldset>

      <!-- 8. Osierdzie -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">8. Osierdzie</legend>
        <div class="mt-2">
          <label class="inline-flex items-center"><input type="checkbox" name="pericardEffusion" class="form-checkbox"/><span class="ml-2">Płyn w osierdziu obecny</span></label>
          <label class="block text-sm mt-2">Ilość / uwagi<textarea name="pericardNotes" class="w-full border rounded p-2 mt-1"></textarea></label>
        </div>
      </fieldset>

      <!-- 9. Uwagi końcowe i rekomendacje -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">9. Uwagi końcowe i rekomendacje</legend>
        <textarea name="remarks" class="w-full border rounded p-2 mt-1" rows="4"></textarea>
      </fieldset>

      <!-- Eksport -->
      <div class="flex space-x-4 mt-6">
        <button type="button" id="exportCsv" class="px-4 py-2 bg-blue-600 text-white rounded">Eksportuj CSV</button>
        <button type="button" id="exportDocx" class="px-4 py-2 bg-green-600 text-white rounded">Eksportuj DOCX</button>
      </div>
    </form>
  </div>

  <script>
    // Render dynamic dim & ves
    const dimensions=[{key:'LVIDd',label:'LV (LVIDd/s) [mm]'},...];
    const vessels=[{key:'OpuszkaAorty',label:'Opuszka aorty [mm]'},...];
    dimensions.forEach(d=>{/* same render */}); vessels.forEach(v=>{/* same */});
    function collectData(){const data={};new FormData(document.getElementById('echoForm')).forEach((v,k)=>{if(v) data[k]=v});return data;}
    document.getElementById('exportCsv').onclick=()=>{const csv=Papa.unparse([collectData()]);const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`echo_${collectData().patientID||'record'}.csv`;a.click();};
    document.getElementById('exportDocx').onclick=async()=>{
      const { Document,Packer,Paragraph,HeadingLevel }=docx;
      const data=collectData();const doc=new Document();const children=[];
      children.push(new Paragraph({text:'Formularz badania echokardiograficznego',heading:HeadingLevel.HEADING_1}));
      const addSection=(t)=>children.push(new Paragraph({text:t,heading:HeadingLevel.HEADING_2}));
      const addField=(l,k)=>{if(data[k]!==undefined)children.push(new Paragraph(`${l}: ${data[k]}`));};
      addSection('1. Dane pacjenta');['patientName','patientID','examDate','operator'].forEach(k=>addField({patientName:'Imię i nazwisko',patientID:'Nr badania / ID',examDate:'Data badania',operator:'Operator / lekarz'}[k],k));
      addSection('2. Wymiary jam serca');dimensions.forEach(d=>addField(d.label,d.key));
      addSection('3. Średnice pni naczyniowych');vessels.forEach(v=>addField(v.label,v.key));
      addSection('4. Objętości i funkcja skurczowa');['EF','EFmethod','EDV','ESV'].forEach(k=>addField({'EF':'EF [%]','EFmethod':'Metoda EF','EDV':'EDV [ml]','ESV':'ESV [ml]'}[k],k));
      addSection('5. Odcinkowe zaburzenia kurczliwości');['segmentalPresent','segmentalDescription'].forEach(k=>addField({'segmentalPresent':'Obecne','segmentalDescription':'Opis segmentów'}[k],k));
      addSection('6. TAPSE');addField('TAPSE [mm]','TAPSE');
      addSection('7. Ocena zastawek');
      // Mitral
      ['mitralRegurg','mitralVC','mitralPISA','mitralERO','mitralEAratio','mitralMxPG','mitralMnPG']
        .forEach(k=>addField({'mitralRegurg':'Regurgitacja mitralna','mitralVC':'VC [cm²]','mitralPISA':'PISA [mm]','mitralERO':'ERO [cm²]','mitralEAratio':'E/A ratio','mitralMxPG':'MxPG [mmHg]','mitralMnPG':'MnPG [mmHg]'}[k],k));
      // Aortic
      ['aorticMorphology','aorticRegSten','aorticVC','aorticPHT','aorticVmax','aorticPmax']
        .forEach(k=>addField({'aorticMorphology':'Morfologia aortalna','aorticRegSten':'Stenoza/regurg','aorticVC':'VC [cm²]','aorticPHT':'PHT [ms]','aorticVmax':'Vmax [m/s]','aorticPmax':'Pmax [mmHg]'}[k],k));
      // Tricuspid
      ['tricuspidRegurg','tricuspidVmax','tricuspidPmax']
        .forEach(k=>addField({'tricuspidRegurg':'Regurgitacja tricuspid','tricuspidVmax':'TR Vmax [m/s]','tricuspidPmax':'Pmax [mmHg]'}[k],k));
      addSection('8. Osierdzie');['pericardEffusion','pericardNotes'].forEach(k=>addField({pericardEffusion:'Płyn obecny','pericardNotes':'Uwagi'}[k],k));
      addSection('9. Uwagi końcowe i rekomendacje');addField('Uwagi','remarks');
      doc.addSection({children});
      const blob=await Packer.toBlob(doc);const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`echo_${data.patientID||'form'}.docx`;a.click();
    };
  </script>
</body>
</html>
