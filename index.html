<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formularz ECHO CLS</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2/dist/tailwind.min.css" rel="stylesheet">
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- docx.js for DOCX -->
  <script src="https://unpkg.com/docx@7.3.0/build/index.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6 bg-white shadow-md mt-10 rounded-lg">
    <header class="flex items-center mb-6">
      <img src="logo_szpitala.png" alt="Logo kliniki" class="h-16 mr-4">
      <div>
        <h1 class="text-xl font-bold">Klinika Kardiologii z Pododdziałem Ostrych Zespołów Wieńcowych</h1>
        <p>Kliniczny Szpital Wojewódzki Nr 2 im. Św. Jadwigi Królowej w Rzeszowie</p>
        <p>ul. Lwowska 60, 35-301 Rzeszów</p>
      </div>
    </header>
    <h2 class="text-lg font-semibold mb-4">Formularz badania echokardiograficznego</h2>
    <form id="echoForm" class="space-y-6">
      <!-- ... Sections 1-6 same ... -->
      <!-- 7. Ocena zastawek -->
      <fieldset class="border p-4 rounded">
        <legend class="font-medium">7. Ocena zastawek</legend>
        <div class="space-y-6 mt-2">
          <!-- Mitralna -->
          <div>
            <h3 class="font-semibold">7.1 Zastawka mitralna</h3>
            <div class="grid grid-cols-2 gap-4 mt-2">
              <div>
                <label class="block text-sm">Niedomykalność<select name="mitralRegurg" class="w-full border rounded p-1">
                  <option value="">-</option>
                  <option value="łagodna">łagodna</option>
                  <option value="umiarkowana">umiarkowana</option>
                  <option value="ciężka">ciężka</option>
                </select></label>
              </div>
              <div>
                <label class="block text-sm">Stenoza<select name="mitralStenosis" class="w-full border rounded p-1">
                  <option value="">-</option>
                  <option value="łagodna">łagodna</option>
                  <option value="umiarkowana">umiarkowana</option>
                  <option value="ciężka">ciężka</option>
                </select></label>
              </div>
            </div>
          </div>
          <!-- Aortalna -->
          <div>
            <h3 class="font-semibold">7.2 Zastawka aortalna</h3>
            <div class="grid grid-cols-2 gap-4 mt-2">
              <div>
                <label class="block text-sm">Niedomykalność<select name="aorticRegurg" class="w-full border rounded p-1">
                  <option value="">-</option>
                  <option value="łagodna">łagodna</option>
                  <option value="umiarkowana">umiarkowana</option>
                  <option value="ciężka">ciężka</option>
                </select></label>
              </div>
              <div>
                <label class="block text-sm">Stenoza<select name="aorticStenosis" class="w-full border rounded p-1">
                  <option value="">-</option>
                  <option value="łagodna">łagodna</option>
                  <option value="umiarkowana">umiarkowana</option>
                  <option value="ciężka">ciężka</option>
                </select></label>
              </div>
            </div>
          </div>
          <!-- Trójdzielna -->
          <div>
            <h3 class="font-semibold">7.3 Zastawka trójdzielna</h3>
            <div class="grid grid-cols-2 gap-4 mt-2">
              <div>
                <label class="block text-sm">Niedomykalność<select name="tricuspidRegurg" class="w-full border rounded p-1">
                  <option value="">-</option>
                  <option value="łagodna">łagodna</option>
                  <option value="umiarkowana">umiarkowana</option>
                  <option value="ciężka">ciężka</option>
                </select></label>
              </div>
              <div>
                <label class="block text-sm">Stenoza<select name="tricuspidStenosis" class="w-full border rounded p-1">
                  <option value="">-</option>
                  <option value="łagodna">łagodna</option>
                  <option value="umiarkowana">umiarkowana</option>
                  <option value="ciężka">ciężka</option>
                </select></label>
              </div>
            </div>
          </div>
        </div>
      </fieldset>

      <!-- ... Sections 8-9, Export same ... -->
    </form>
  </div>

  <script>
    // ... dynamic field rendering same ...
    // Collect form data
    function collectData() {
      const data = {};
      new FormData(document.getElementById('echoForm')).forEach((val, key) => { if(val) data[key] = val; });
      return data;
    }
    // CSV Export unchanged
    // DOCX Export with conditional fields
    document.getElementById('exportDocx').addEventListener('click', async () => {
      const { Document, Packer, Paragraph, HeadingLevel } = docx;
      const data = collectData();
      const doc = new Document();
      const children = [];
      children.push(new Paragraph({ text: 'Formularz badania echokardiograficznego', heading: HeadingLevel.HEADING_1 }));
      function addSection(title) { children.push(new Paragraph({ text: title, heading: HeadingLevel.HEADING_2 })); }
      function addField(label, key) { if(data[key] !== undefined) children.push(new Paragraph(`${label}: ${data[key]}`)); }
      addSection('1. Dane pacjenta');
      addField('Imię i nazwisko','patientName'); addField('Nr badania / ID','patientID'); addField('Data badania','examDate'); addField('Operator / lekarz','operator');
      addSection('2. Wymiary jam serca'); dimensions.forEach(d=>addField(d.label,d.key));
      addSection('3. Średnice pni naczyniowych'); vessels.forEach(v=>addField(v.label,v.key));
      addSection('4. Objętości i funkcja skurczowa'); addField('EF [%]','EF'); addField('Metoda EF','EFmethod'); addField('EDV [ml]','EDV'); addField('ESV [ml]','ESV');
      addSection('5. Odcinkowe zaburzenia kurczliwości'); addField('Obecne','segmentalPresent'); addField('Opis segmentów','segmentalDescription');
      addSection('6. TAPSE'); addField('TAPSE [mm]','TAPSE');
      addSection('7. Ocena zastawek');
      ['mitral','aortic','tricuspid'].forEach(valve=>{
        addField(`${valve.charAt(0).toUpperCase()+valve.slice(1)} - niedomykalność`, valve+ (valve==='aortic'?'Regurg':'Regurg'));
        addField(`${valve.charAt(0).toUpperCase()+valve.slice(1)} - stenoza`, valve+'Stenosis');
      });
      addSection('8. Osierdzie'); addField('Płyn obecny','pericardEffusion'); addField('Uwagi','pericardNotes');
      addSection('9. Uwagi końcowe i rekomendacje'); addField('Uwagi','remarks');
      doc.addSection({ children });
      const blob = await Packer.toBlob(doc);
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
      link.download = `echo_${data.patientID||'form'}.docx`; link.click();
    });
  </script>
</body>
</html>
